<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Refund Details - TreasureGO</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    /* åŸºç¡€è®¾ç½® */
    :root { --bg-color: #F3F6F9; --primary: #4F46E5; --text-dark: #1F2937; --text-gray: #6B7280; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Poppins', sans-serif; background: var(--bg-color); color: var(--text-dark); padding-bottom: 50px; }

    /* å¸ƒå±€å®¹å™¨ */
    .container { max-width: 800px; margin: 40px auto; padding: 0 20px; }

    /* é¡¶éƒ¨å¯¼èˆª */
    .header-nav { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; }
    .back-btn { text-decoration: none; color: var(--text-dark); font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
    .back-btn:hover { color: var(--primary); transform: translateX(-3px); }

    /* çŠ¶æ€æ¨ªå¹… (æ›¿ä»£è¿›åº¦æ¡çš„æ ¸å¿ƒä¿¡æ¯å±•ç¤º) */
    .status-banner {
      padding: 20px 25px; border-radius: 16px; margin-bottom: 25px;
      display: flex; gap: 15px; align-items: flex-start;
      box-shadow: 0 4px 15px rgba(0,0,0,0.03);
      animation: fadeIn 0.3s ease-out;
    }
    .status-banner i { font-size: 1.4rem; margin-top: 2px; }
    .status-content h3 { margin: 0 0 5px 0; font-size: 1.1rem; }
    .status-content p { margin: 0; font-size: 0.95rem; opacity: 0.9; line-height: 1.5; }

    /* çŠ¶æ€é¢œè‰²é£æ ¼ */
    .banner-pending { background: #FFF7ED; border: 1px solid #FED7AA; color: #9A3412; }
    .banner-pending i { color: #F97316; }

    .banner-success { background: #F0FDF4; border: 1px solid #86EFAC; color: #166534; }
    .banner-success i { color: #16A34A; }

    .banner-rejected { background: #FEF2F2; border: 1px solid #FECACA; color: #991B1B; }
    .banner-rejected i { color: #EF4444; }

    .banner-return { background: #EFF6FF; border: 1px solid #BFDBFE; color: #1E40AF; }
    .banner-return i { color: #3B82F6; }

    /* ä¿¡æ¯ç½‘æ ¼ */
    .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
    .info-card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.02); }

    .label { font-size: 0.8rem; color: #9CA3AF; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 8px; }
    .value { font-size: 1.1rem; font-weight: 600; color: #1F2937; }
    .amount-text { color: var(--primary); font-size: 1.6rem; font-weight: 800; }

    /* å‡­è¯å›¾ç‰‡ */
    .gallery-grid { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    .evidence-img { width: 90px; height: 90px; border-radius: 12px; object-fit: cover; cursor: pointer; border: 1px solid #E5E7EB; transition: 0.2s; }
    .evidence-img:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

<div class="container">
  <div class="header-nav">
    <a href="#" onclick="history.back()" class="back-btn"><i class="ri-arrow-left-line"></i> Back to Order</a>
    <h2 style="margin:0; margin-left: 15px; font-size: 1.5rem;">Refund Details</h2>
  </div>

  <div id="statusMessageContainer"></div>

  <div class="details-grid">
    <div class="info-card">
      <div class="label">Refund Amount</div>
      <div class="value amount-text" id="refundAmount">RM0.00</div>
      <div style="margin-top:20px;" class="label">Refund Type</div>
      <div class="value" id="refundType">-</div>
    </div>

    <div class="info-card">
      <div class="label">Reason Category</div>
      <div class="value" id="refundReason">-</div>
      <div style="margin-top:20px;" class="label">Request Date</div>
      <div class="value" style="font-size:1rem;" id="refundDate">-</div>
    </div>
  </div>

  <div class="info-card">
    <div class="label">Detailed Description</div>
    <p style="color:#4B5563; line-height:1.7; font-size: 0.95rem; background:#F9FAFB; padding:15px; border-radius:10px;" id="refundDesc">
      No description provided.
    </p>

    <div style="margin-top:30px;">
      <div class="label">Evidence / Photos</div>
      <div class="gallery-grid" id="evidenceGallery">
        <span style="color:#9CA3AF; font-size:0.9rem; font-style:italic;">No photos uploaded.</span>
      </div>
    </div>
  </div>

</div>

<script>
  // è·å– URL å‚æ•°
  const urlParams = new URLSearchParams(window.location.search);
  const ORDER_ID = urlParams.get('order_id');

  // ğŸ”¥ğŸ”¥ğŸ”¥ å·²æ ¹æ®ä½ çš„è¦æ±‚æ›´æ–°ä¸ºæ­£ç¡®çš„è·¯å¾„ ğŸ”¥ğŸ”¥ğŸ”¥
  const API_URL = '../../Module_Transaction_Fund/api/Get_User_Orders.php';

  async function loadDetails() {
    if(!ORDER_ID) return alert("No Order ID provided.");

    try {
      // 1. è°ƒç”¨ API è·å–è®¢å•æ•°æ®
      const res = await fetch(API_URL);

      // æ£€æŸ¥ç½‘ç»œæˆ–è·¯å¾„é”™è¯¯
      if (!res.ok) {
        throw new Error(`API Path Error: ${res.status} ${res.statusText}. Path tried: ${API_URL}`);
      }

      const data = await res.json();

      if(!data.success) throw new Error(data.msg || "Failed to load order data.");

      // 2. åœ¨ä¹°å®¶å’Œå–å®¶åˆ—è¡¨ä¸­æŸ¥æ‰¾å¯¹åº”è®¢å•
      const allOrders = [...(data.buying || []), ...(data.selling || [])];
      const order = allOrders.find(o => o.Orders_Order_ID == ORDER_ID);

      if(order) {
        renderPage(order);
      } else {
        document.body.innerHTML = "<div style='text-align:center; margin-top:50px;'><h3>Order Not Found</h3><p>Could not find order #" + ORDER_ID + "</p><button onclick='history.back()'>Go Back</button></div>";
      }

    } catch(e) {
      console.error(e);
      document.getElementById('statusMessageContainer').innerHTML = `<div style="background:#FEF2F2; border:1px solid #FECACA; color:#991B1B; padding:15px; border-radius:12px; text-align:center;"><strong>Error:</strong> ${e.message}</div>`;
    }
  }

  function renderPage(order) {
    // 1. å¡«å……åŸºç¡€æ–‡æœ¬ä¿¡æ¯
    const amount = order.Refund_Amount ? parseFloat(order.Refund_Amount).toFixed(2) : '0.00';
    document.getElementById('refundAmount').innerText = 'RM' + amount;

    // ç®€å•çš„ç±»å‹æ˜ å°„
    let typeText = '-';
    if (order.Refund_Type === 'refund_only') typeText = 'Refund Only';
    else if (order.Refund_Type === 'return_refund') typeText = 'Return & Refund';
    document.getElementById('refundType').innerText = typeText;

    document.getElementById('refundReason').innerText = order.Refund_Reason || 'Not Specified';

    // ä¼˜å…ˆä½¿ç”¨æ›´æ–°æ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨åˆ›å»ºæ—¶é—´æˆ–å½“å‰æ—¶é—´
    const dateStr = order.Refund_Updated_At || order.Refund_Created_At || new Date().toISOString();
    document.getElementById('refundDate').innerText = new Date(dateStr).toLocaleDateString();

    if(order.Refund_Description) {
      document.getElementById('refundDesc').innerText = order.Refund_Description;
    }

    // 2. æ ¹æ®çŠ¶æ€æ¸²æŸ“ Banner
    const statusDiv = document.getElementById('statusMessageContainer');
    const status = order.Refund_Status;
    let bannerHtml = '';

    if(status === 'pending_approval') {
      bannerHtml = `
            <div class="status-banner banner-pending">
                <i class="ri-hourglass-fill"></i>
                <div class="status-content">
                    <h3>Waiting for Seller Review</h3>
                    <p>The request has been sent. The seller will review your request shortly.</p>
                </div>
            </div>`;
    }
    else if (status === 'awaiting_return') {
      bannerHtml = `
            <div class="status-banner banner-return">
                <i class="ri-truck-line"></i>
                <div class="status-content">
                    <h3>Return Accepted</h3>
                    <p>Seller has accepted. Please return the item and submit the tracking number.</p>
                </div>
            </div>`;
    }
    else if (status === 'completed') {
      bannerHtml = `
            <div class="status-banner banner-success">
                <i class="ri-checkbox-circle-fill"></i>
                <div class="status-content">
                    <h3>Refund Completed</h3>
                    <p>Funds have been successfully returned to the buyer's wallet.</p>
                </div>
            </div>`;
    }
    else if (status === 'rejected') {
      bannerHtml = `
            <div class="status-banner banner-rejected">
                <i class="ri-close-circle-fill"></i>
                <div class="status-content">
                    <h3>Request Rejected</h3>
                    <p>The seller has rejected this refund request. You may contact support.</p>
                </div>
            </div>`;
    }
    else {
      // é»˜è®¤çŠ¶æ€
      bannerHtml = `
            <div class="status-banner" style="background:#F3F4F6; color:#374151;">
                <i class="ri-information-line"></i>
                <div class="status-content">
                    <h3>Status: ${status || 'Unknown'}</h3>
                </div>
            </div>`;
    }

    statusDiv.innerHTML = bannerHtml;

    // 3. å¤„ç†å›¾ç‰‡ (å¦‚æœæœ‰ Refund_Images å­—æ®µ)
    const gallery = document.getElementById('evidenceGallery');
    if(order.Refund_Images) {
      gallery.innerHTML = '';
      let images = [];
      try {
        if(order.Refund_Images.startsWith('[')) images = JSON.parse(order.Refund_Images);
        else images = order.Refund_Images.split(',');
      } catch(e) { images = [order.Refund_Images]; }

      images.forEach(src => {
        if(src && src.trim()) {
          const img = document.createElement('img');
          // ç®€å•çš„è·¯å¾„ä¿®æ­£é€»è¾‘ï¼šå¦‚æœä¸æ˜¯ http å¼€å¤´ä¹Ÿä¸æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œå‡è®¾å®ƒåœ¨æ ¹ç›®å½•ä¸‹
          let cleanSrc = src.trim();
          if(!cleanSrc.startsWith('http') && !cleanSrc.startsWith('../')) {
            cleanSrc = '../../' + cleanSrc;
          }
          img.src = cleanSrc;
          img.className = 'evidence-img';
          img.onclick = () => window.open(img.src, '_blank');
          gallery.appendChild(img);
        }
      });
    }
  }

  loadDetails();
</script>

</body>
</html>