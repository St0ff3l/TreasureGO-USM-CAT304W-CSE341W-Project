<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Checkout Membership - TreasureGO</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="../../Public_Assets/js/status_dialog.js"></script> <style>
  /* --- Core Variables --- */
  :root {
    --bg-color: #F3F6F9;
    --primary: #4F46E5;
    --primary-hover: #4338CA;
    --text-dark: #1F2937;
    --text-gray: #6B7280;
    --glass-bg: rgba(255, 255, 255, 0.95);
    --gold: #F59E0B;
    --gold-light: #FFFBEB;
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { font-family: 'Poppins', 'Noto Sans SC', sans-serif; background: var(--bg-color); color: var(--text-dark); min-height: 100vh; margin: 0; padding-bottom: 40px; }

  /* --- Navbar --- */
  .navbar { background: var(--glass-bg); backdrop-filter: blur(12px); padding: 1rem 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid rgba(255,255,255,0.5); }

  /* --- Layout --- */
  .container { max-width: 1000px; margin: 40px auto; padding: 0 20px; display: grid; grid-template-columns: 1.5fr 1fr; gap: 30px; align-items: start; }
  .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 20px; transition: 0.3s; }
  h2 { margin-top: 0; margin-bottom: 20px; font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }

  /* --- Single Payment Method Style --- */
  .wallet-card {
    display: flex;
    align-items: center;
    justify-content: center;
    background: #EEF2FF;
    border: 2px solid var(--primary);
    padding: 25px;
    border-radius: 16px;
    color: var(--primary);
    margin-bottom: 20px;
    text-align: center;
  }
  .wallet-info { display: flex; align-items: center; gap: 15px; }
  .wallet-icon { font-size: 2.2rem; }
  .wallet-text { text-align: left; }
  .wallet-text h4 { margin: 0; font-size: 1.1rem; }
  .wallet-text p { margin: 2px 0 0 0; font-size: 0.9rem; opacity: 0.8; }

  /* --- Membership Summary Style --- */
  .plan-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
  .plan-icon { width: 60px; height: 60px; border-radius: 12px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; }
  .plan-details h3 { margin: 0 0 4px 0; font-size: 1.1rem; }
  .plan-cycle { color: var(--text-gray); font-size: 0.9rem; margin: 0; }

  /* Style variations for SVIP */
  .card.svip-theme { border: 2px solid var(--gold); background: linear-gradient(to bottom, #FFFCF5, #FFFFFF); }
  .svip-text { color: var(--gold); }
  .card.vip-theme { border: 2px solid #eee; }

  .summary-row { display: flex; justify-content: space-between; margin-bottom: 12px; color: #555; font-size: 0.95rem; }
  .total-row { display: flex; justify-content: space-between; margin-top: 20px; padding-top: 20px; border-top: 2px dashed #eee; font-weight: 800; font-size: 1.4rem; color: var(--text-dark); }

  /* Buttons */
  .btn-pay { width: 100%; background: var(--primary); color: white; border: none; padding: 16px; border-radius: 14px; font-size: 1.1rem; font-weight: 700; cursor: pointer; margin-top: 25px; box-shadow: 0 10px 25px rgba(79, 70, 229, 0.25); transition: 0.2s; }
  .btn-pay:hover { background: var(--primary-hover); transform: translateY(-2px); }
  .btn-pay.gold-btn { background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3); }

  .btn-cancel { width: 100%; display: block; text-align: center; margin-top: 15px; color: var(--text-gray); text-decoration: none; font-weight: 600; font-size: 0.95rem; }
  .btn-cancel:hover { color: var(--text-dark); }

  /* Terms Text */
  .terms-text { font-size: 0.8rem; color: #888; text-align: center; line-height: 1.5; margin-top: 0px; padding-top: 15px; border-top: 1px solid #f0f0f0; }

  /* --- Payment PIN Modal Styles --- */
  .pin-modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px);
    z-index: 2000; display: none; align-items: center; justify-content: center;
    opacity: 0; transition: opacity 0.3s ease;
  }
  .pin-modal-overlay.active { opacity: 1; }

  .pin-card {
    background: #fff; width: 90%; max-width: 360px;
    border-radius: 24px; padding: 30px; text-align: center;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }
  .pin-modal-overlay.active .pin-card { transform: scale(1); }

  .pin-input-container { margin: 24px 0; position: relative; }
  .pin-real-input {
    width: 100%; height: 50px; opacity: 0; position: absolute; top: 0; left: 0; z-index: 2;
    cursor: text;
  }

  /* 6-box Styles */
  .pin-boxes { display: flex; gap: 8px; justify-content: center; }
  .pin-box {
    width: 45px; height: 50px; border: 2px solid #E2E8F0; border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.5rem; font-weight: 700; color: var(--text-dark);
    background: #F8FAFC; transition: all 0.2s;
  }
  .pin-box.active { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 4px var(--primary-light); }
  .pin-box.filled { background: #fff; border-color: #CBD5E1; }

  @media (max-width: 768px) {
    .navbar { padding: 1rem 20px; }
    .container { margin-top: 20px; grid-template-columns: 1fr; gap: 20px; }
  }
</style>
</head>
<body>

<script src="../../Public_Assets/js/headerbar.js"></script>
<script>TreasureGoHeaderbar.mount({ basePath: '../../' });</script>

<div class="container">
  <div class="left-col">
    <div class="card">
      <h2>ðŸ’³ Payment Method</h2>

      <div class="wallet-card">
        <div class="wallet-info">
          <div class="wallet-icon">ðŸ’°</div>
          <div class="wallet-text">
            <h4>My Wallet</h4>
            <p>Balance: RM...</p>
          </div>
        </div>
      </div>

      <div class="terms-text">
        By clicking "Pay", you agree to TreasureGo's <a href="#" style="color:var(--primary); text-decoration:none;">Terms of Service</a>. <br>
        Membership benefits are applied immediately upon successful payment.
      </div>
    </div>

    <div style="text-align:center; padding: 0 20px;">
      <p style="color:#9CA3AF; font-size:0.85rem;">
        <span style="vertical-align: middle; margin-right:5px;">ðŸ”’</span>
        Secure Payment with PIN Protection
      </p>
    </div>
  </div>

  <div class="right-col">
    <div class="card" id="summary-card">
      <h2>Order Summary</h2>

      <div class="plan-header">
        <div class="plan-icon" id="plan-icon">ðŸ’Ž</div>
        <div class="plan-details">
          <h3 id="plan-name">VIP Membership</h3>
          <p class="plan-cycle" id="cycle-display">Monthly Plan</p>
        </div>
      </div>

      <div class="summary-row"><span>Plan Price</span><span id="subtotal">RM0.00</span></div>
      <div class="summary-row"><span>Discount</span><span id="discount" style="color:green;">-RM0.00</span></div>
      <div class="summary-row"><span>Tax (0%)</span><span>RM0.00</span></div>

      <div class="total-row">
        <span>Total Due</span>
        <span id="total-price" style="color:var(--primary);">RM0.00</span>
      </div>

      <button class="btn-pay" id="pay-btn" onclick="handlePayClick()">Pay</button>

      <a href="javascript:history.back()" class="btn-cancel">Cancel & Go Back</a>
    </div>
  </div>
</div>

<div id="pin-modal" class="pin-modal-overlay">
  <div class="pin-card">
    <div style="font-size: 3rem; margin-bottom: 10px;">ðŸ”’</div>
    <h3 style="margin: 0 0 8px 0; font-size: 1.25rem;">Enter Payment PIN</h3>
    <p style="margin: 0 0 20px 0; color: #64748B; font-size: 0.9rem;">Please enter your 6-digit PIN to confirm.</p>

    <div class="pin-input-container">
      <input type="tel" maxlength="6" id="real-pin-input" class="pin-real-input" autocomplete="off" inputmode="numeric">

      <div class="pin-boxes">
        <div class="pin-box"></div><div class="pin-box"></div><div class="pin-box"></div>
        <div class="pin-box"></div><div class="pin-box"></div><div class="pin-box"></div>
      </div>
    </div>

    <div style="display: flex; gap: 10px;">
      <button onclick="closePinModal()" style="flex: 1; border: none; padding: 12px; border-radius: 14px; font-size: 1rem; font-weight: 700; cursor: pointer; background: #F1F5F9; color: #64748B; transition: 0.2s;">Cancel</button>
      <button onclick="confirmPinPayment()" id="btn-confirm-pin" class="btn-pay" style="flex: 1; margin-top: 0; padding: 12px; font-size: 1rem; opacity: 0.5; pointer-events: none;">Confirm</button>
    </div>
  </div>
</div>

<script>
  // 1. Get URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const planType = urlParams.get('plan') || 'VIP';
  const cycle = urlParams.get('cycle') || 'monthly';
  const rawPrice = urlParams.get('price') || '9.90';
  const priceValue = parseFloat(rawPrice.replace(/[^0-9.]/g, ''));

  // Global variables
  let realUserBalance = 0.00;
  let userHasPin = false; // New: Check if user has PIN

  // 2. Page load initialization
  document.addEventListener('DOMContentLoaded', () => {
    renderPlanDetails();
    fetchUserBalance();
  });

  // --- Fetch balance and PIN status ---
  async function fetchUserBalance() {
    try {
      const response = await fetch('../api/Get_Wallet_Balance.php');
      const data = await response.json();

      if (data.success) {
        realUserBalance = parseFloat(data.balance);

        // New: Check the has_pin field returned by the backend
        if (typeof data.has_pin !== 'undefined') {
          userHasPin = Boolean(data.has_pin);
        } else {
          console.warn("Backend missing has_pin");
        }

        // Update page display
        const balanceDisplay = document.querySelector('.wallet-text p');
        if (balanceDisplay) {
          balanceDisplay.innerText = `Balance: RM${realUserBalance.toFixed(2)}`;
        }
      } else {
        console.error("Fetch balance failed:", data.msg);
      }
    } catch (error) {
      console.error("Network error:", error);
    }
  }

  function renderPlanDetails() {
    const cycleText = cycle.charAt(0).toUpperCase() + cycle.slice(1);
    document.getElementById('cycle-display').innerText = `${cycleText} Billing`;
    document.getElementById('subtotal').innerText = `RM${priceValue.toFixed(2)}`;
    document.getElementById('total-price').innerText = `RM${priceValue.toFixed(2)}`;

    const summaryCard = document.getElementById('summary-card');
    const planIcon = document.getElementById('plan-icon');
    const planName = document.getElementById('plan-name');
    const payBtn = document.getElementById('pay-btn');
    const totalDisplay = document.getElementById('total-price');

    if (planType === 'SVIP') {
      planName.innerText = "SVIP Membership";
      planIcon.innerText = "ðŸ‘‘";
      planIcon.style.background = "#FFFBEB";
      planIcon.style.color = "#F59E0B";

      summaryCard.classList.add('svip-theme');
      payBtn.classList.add('gold-btn');
      totalDisplay.style.color = "#D97706";
    } else {
      planName.innerText = "VIP Membership";
      planIcon.innerText = "ðŸ’Ž";
      planIcon.style.background = "#EEF2FF";
      planIcon.style.color = "#4F46E5";
      summaryCard.classList.add('vip-theme');
    }
  }

  // --- New: Click payment button logic ---
  function handlePayClick() {
    // 1. Check balance (Frontend preliminary check)
    if (priceValue > realUserBalance) {
      window.location.href = `Payment_Failure.html?type=membership&reason=Insufficient Balance`;
      return;
    }

    // 2. Check if PIN exists
    if (!userHasPin) {
      StatusDialog.confirm(
              'Set Payment PIN',
              'For security, you must set a 6-digit Payment PIN before purchasing.',
              'Set PIN Now',
              function() {
                window.location.href = '../../Module_User_Account_Management/pages/profile.php#security';
              }
      );
      return;
    }

    // 3. Open PIN modal
    openPinModal();
  }

  // --- PIN Modal Controls ---
  const pinModal = document.getElementById('pin-modal');
  const realInput = document.getElementById('real-pin-input');
  const boxes = document.querySelectorAll('.pin-box');
  const confirmBtn = document.getElementById('btn-confirm-pin');

  function openPinModal() {
    pinModal.style.display = 'flex';
    setTimeout(() => pinModal.classList.add('active'), 10);
    realInput.value = '';
    updatePinVisuals();
    realInput.focus();
  }

  function closePinModal() {
    pinModal.classList.remove('active');
    setTimeout(() => pinModal.style.display = 'none', 300);
    realInput.blur();
  }

  realInput.addEventListener('input', (e) => {
    realInput.value = realInput.value.replace(/[^0-9]/g, '');
    updatePinVisuals();

    if (realInput.value.length === 6) {
      confirmBtn.style.opacity = '1';
      confirmBtn.style.pointerEvents = 'auto';
    } else {
      confirmBtn.style.opacity = '0.5';
      confirmBtn.style.pointerEvents = 'none';
    }
  });

  function updatePinVisuals() {
    const val = realInput.value;
    boxes.forEach((box, index) => {
      if (index < val.length) {
        box.innerText = 'â€¢';
        box.classList.add('filled');
        box.classList.remove('active');
      } else if (index === val.length) {
        box.innerText = '';
        box.classList.add('active');
        box.classList.remove('filled');
      } else {
        box.innerText = '';
        box.classList.remove('filled', 'active');
      }
    });
  }

  function confirmPinPayment() {
    const pinCode = realInput.value;
    if (pinCode.length !== 6) return;
    closePinModal();
    processPayment(pinCode); // Call real payment, pass PIN
  }

  // --- Process payment logic (Real deduction) ---
  async function processPayment(pinCode) {
    const btn = document.getElementById('pay-btn');
    btn.disabled = true;
    btn.innerText = "Processing...";
    btn.style.opacity = "0.7";

    const payload = {
      price: priceValue,
      plan: planType,
      cycle: cycle,
      payment_pin: pinCode // New: Pass PIN code
    };

    const urlParamsStr = `type=membership&plan=${encodeURIComponent(planType)}&cycle=${encodeURIComponent(cycle)}&price=${encodeURIComponent(rawPrice)}`;

    try {
      const response = await fetch('../api/Process_Payment.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const result = await response.json();

      if (result.success) {
        window.location.href = `Payment_Success.html?${urlParamsStr}`;
      } else {
        console.error("Payment failed:", result.msg);

        // Handle PIN errors
        if (result.msg && (result.msg.includes('PIN') || result.msg.includes('Password'))) {
          StatusDialog.fail('Incorrect PIN', result.msg, 'Try Again', () => {
            openPinModal(); // Re-open modal
          });
        } else {
          // Redirect to failure page for other errors
          window.location.href = `Payment_Failure.html?${urlParamsStr}&reason=${encodeURIComponent(result.msg)}`;
        }

        // Reset button (If it is a PIN error, the user is still on the current page)
        btn.innerText = "Pay";
        btn.disabled = false;
        btn.style.opacity = "1";
      }

    } catch (error) {
      console.error("Network Error:", error);
      StatusDialog.fail('Connection Error', 'Please check your internet connection.');
      btn.innerText = "Pay";
      btn.disabled = false;
      btn.style.opacity = "1";
    }
  }
</script>

</body>
</html>