<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TreasureGO - Admin Audit</title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    /* ========================================= */
    /* æ ¸å¿ƒæ ·å¼ (Core Styles) */
    /* ========================================= */
    :root {
      --bg-color: #F3F6F9;
      --primary: #4F46E5;
      --primary-hover: #4338CA;
      --danger: #DC2626;
      --text-dark: #1F2937;
      --text-gray: #6B7280;
      --card-radius: 20px;
      --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-dark);
      min-height: 100vh;
      /* ä¿æŒä¸»é¡µçš„èƒŒæ™¯é£æ ¼ï¼Œä½†å»æ‰æµ®åŠ¨åŠ¨ç”»å¹²æ‰° */
      background-image:
              radial-gradient(circle at 10% 20%, rgba(79, 70, 229, 0.05) 0%, transparent 40%),
              radial-gradient(circle at 90% 80%, rgba(245, 158, 11, 0.05) 0%, transparent 40%);
      padding-bottom: 60px;
    }

    /* ========================================= */
    /* é¡µé¢å¸ƒå±€ */
    /* ========================================= */
    .container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 20px;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .page-title {
      font-size: 2rem;
      font-weight: 800;
      color: var(--text-dark);
      position: relative;
      padding-left: 20px;
    }
    .page-title::before {
      content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%);
      width: 6px; height: 30px; background: var(--primary); border-radius: 4px;
    }

    /* ç­›é€‰ Tab */
    .tabs {
      display: flex; gap: 10px; background: white; padding: 5px;
      border-radius: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .tab-btn {
      border: none; background: transparent; padding: 10px 25px;
      border-radius: 40px; font-weight: 600; color: var(--text-gray);
      cursor: pointer; transition: var(--transition);
    }
    .tab-btn.active {
      background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }
    .tab-btn:hover:not(.active) { background: #f3f4f6; color: var(--text-dark); }

    /* ========================================= */
    /* åˆ—è¡¨é¡¹æ ·å¼ (List Item) - æ¡çŠ¶è®¾è®¡ */
    /* ========================================= */
    .audit-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .audit-item {
      background: white;
      border-radius: var(--card-radius);
      box-shadow: var(--card-shadow);
      overflow: hidden;
      transition: var(--transition);
      border: 1px solid rgba(0,0,0,0.02);
    }

    .audit-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.08);
    }

    /* --- ä¸»è¡Œ (Summary Row) --- */
    .item-summary {
      display: grid;
      /* å®šä¹‰åˆ—å®½ï¼šå›¾ç‰‡ | ä¿¡æ¯ | å–å®¶ | ä»·æ ¼ | çŠ¶æ€ | æ“ä½œ */
      grid-template-columns: 80px 2fr 1.5fr 1fr 1fr 120px;
      align-items: center;
      padding: 20px;
      gap: 20px;
      cursor: pointer; /* æš—ç¤ºå¯ç‚¹å‡»å±•å¼€ */
    }

    /* å›¾ç‰‡ */
    .item-thumb {
      width: 80px; height: 80px; border-radius: 12px;
      object-fit: cover; background: #f3f4f6;
    }
    .no-img {
      width: 80px; height: 80px; border-radius: 12px;
      background: #f3f4f6; display: flex; align-items: center; justify-content: center; font-size: 2rem;
    }

    /* æ–‡æœ¬åˆ— */
    .col-info h4 { font-size: 1.1rem; font-weight: 700; color: var(--text-dark); margin-bottom: 4px; }
    .col-info p { font-size: 0.85rem; color: var(--text-gray); display: flex; gap: 8px; align-items: center; }
    .badge-cat { background: #EEF2FF; color: var(--primary); padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }

    .col-seller { display: flex; align-items: center; gap: 10px; }
    .avatar { width: 32px; height: 32px; border-radius: 50%; background: #ddd; object-fit: cover; }
    .seller-name { font-size: 0.9rem; font-weight: 600; }

    .col-price { font-weight: 800; color: var(--text-dark); font-size: 1.1rem; }

    .col-status span {
      padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700;
      display: inline-block;
    }
    .status-pending { background: #FEF3C7; color: #D97706; }
    .status-approved { background: #D1FAE5; color: #059669; }
    .status-rejected { background: #FEE2E2; color: #DC2626; }

    /* æ“ä½œæŒ‰é’® */
    .col-actions { display: flex; gap: 10px; justify-content: flex-end; }
    .btn-action {
      width: 36px; height: 36px; border-radius: 50%; border: none;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: var(--transition); font-size: 1.2rem;
    }
    .btn-approve { background: #D1FAE5; color: #059669; }
    .btn-approve:hover { background: #059669; color: white; transform: scale(1.1); }
    .btn-reject { background: #FEE2E2; color: #DC2626; }
    .btn-reject:hover { background: #DC2626; color: white; transform: scale(1.1); }

    /* --- è¯¦æƒ…å±•å¼€åŒºåŸŸ (Details Panel) --- */
    .item-details {
      max-height: 0; overflow: hidden;
      background: #fafafa; border-top: 1px dashed #e5e7eb;
      transition: max-height 0.4s ease-out;
    }
    .item-details.open { max-height: 500px; }

    .details-content { padding: 25px; display: flex; gap: 40px; }
    .detail-desc { flex: 2; }
    .detail-meta { flex: 1; border-left: 1px solid #e5e7eb; padding-left: 30px; }

    .detail-label { font-size: 0.8rem; color: #9ca3af; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; display: block; }
    .detail-text { font-size: 0.95rem; color: #4b5563; line-height: 1.6; margin-bottom: 20px; }

    /* æ¨¡æ€æ¡† (Reject Modal) */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
      z-index: 2000; display: none; align-items: center; justify-content: center;
      opacity: 0; transition: opacity 0.3s;
    }
    .modal-overlay.show { display: flex; opacity: 1; }

    .modal-card {
      background: white; width: 90%; max-width: 450px;
      border-radius: 24px; padding: 30px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.2);
      transform: translateY(20px); transition: transform 0.3s;
    }
    .modal-overlay.show .modal-card { transform: translateY(0); }

    .modal-title { font-size: 1.5rem; font-weight: 800; margin-bottom: 15px; }
    .modal-textarea {
      width: 100%; height: 120px; border: 2px solid #e5e7eb; border-radius: 12px;
      padding: 15px; font-family: inherit; font-size: 1rem; resize: none; outline: none;
      margin-bottom: 20px; transition: border-color 0.2s;
    }
    .modal-textarea:focus { border-color: var(--primary); }

    .modal-btns { display: flex; justify-content: flex-end; gap: 10px; }
    .btn-modal { padding: 10px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; border: none; }
    .btn-cancel { background: #f3f4f6; color: #4b5563; }
    .btn-confirm-reject { background: var(--danger); color: white; }

    @media (max-width: 768px) {
      .item-summary { grid-template-columns: 60px 1fr auto; gap: 10px; padding: 15px; }
      .col-info { grid-column: 2 / 3; }
      .col-actions { grid-column: 3 / 4; grid-row: 1 / 3; flex-direction: column; }
      .col-seller, .col-price, .col-status { display: none; } /* ç§»åŠ¨ç«¯ç®€åŒ–æ˜¾ç¤º */
      .item-thumb { width: 60px; height: 60px; }
    }
  </style>
</head>
<body>

<script src="../../Public_Assets/js/headerbar.js"></script>
<script>
  TreasureGoHeaderbar.mount({ basePath: '../../' });
</script>

<div class="container">
  <div class="page-header">
    <h1 class="page-title">Listing Audit</h1>

    <div class="tabs">
      <button class="tab-btn active" onclick="filterList('pending')">Pending</button>
      <button class="tab-btn" onclick="filterList('history')">History</button>
    </div>
  </div>

  <div class="audit-list" id="audit-list-container">
    <div style="text-align:center; padding: 40px; color: #999;">Loading... â³</div>
  </div>
</div>

<div class="modal-overlay" id="rejectModal">
  <div class="modal-card">
    <h3 class="modal-title">Reject Reason</h3>
    <p style="margin-bottom:10px; color:#6b7280; font-size:0.9rem;">Please explain why this listing violates the guidelines.</p>
    <textarea class="modal-textarea" id="rejectReasonInput" placeholder="e.g. Inappropriate content, Wrong category..."></textarea>
    <div class="modal-btns">
      <button class="btn-modal btn-cancel" onclick="closeRejectModal()">Cancel</button>
      <button class="btn-modal btn-confirm-reject" onclick="confirmReject()">Confirm Reject</button>
    </div>
  </div>
</div>

<script>
  let currentRejectId = null;

  // IMPORTANT: Adjust this path based on where this HTML file is located relative to the api folder.
  // Assuming this HTML is in: Module_Platform_Governance_AI_Services/pages/
  // And API is in: Module_Platform_Governance_AI_Services/api/
  const API_BASE = '../api/';

  // --- 1. Load Data ---
  async function loadAuditList(status = 'pending') {
    const container = document.getElementById('audit-list-container');
    container.innerHTML = '<div style="text-align:center; padding: 40px; color: #999;">Loading... â³</div>';

    try {
      const response = await fetch(`${API_BASE}Get_Audit_Products.php?status=${status}`);
      const result = await response.json();

      if (result.success) {
        renderList(result.data);
      } else {
        container.innerHTML = `<div style="text-align:center; padding: 60px; color: red;">Error: ${result.msg}</div>`;
      }
    } catch (error) {
      console.error('Fetch error:', error);
      container.innerHTML = '<div style="text-align:center; padding: 60px; color: red;">Network Error. Please check console.</div>';
    }
  }

  // --- 2. Initial Load ---
  document.addEventListener('DOMContentLoaded', () => {
    loadAuditList('pending');
  });

  // --- 3. Filter Tabs ---
  function filterList(type) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    loadAuditList(type);
  }

  // --- 4. Render List ---
  function renderList(items) {
    const container = document.getElementById('audit-list-container');
    container.innerHTML = '';

    if (!items || items.length === 0) {
      container.innerHTML = '<div style="text-align:center; padding: 60px; color: #999;">No items found. âœ¨</div>';
      return;
    }

    items.forEach(item => {
      // 1. å›¾ç‰‡è·¯å¾„å¤„ç†
      let imgHtml = '<div class="no-img">ğŸ“¦</div>';
      if (item.image) {
        const cleanPath = item.image.replace(/^\.\.\//, '');
        const finalPath = '../../' + cleanPath;

        // ğŸ”¥ ä¿®å¤é—ªçƒçš„æ ¸å¿ƒä»£ç ï¼š
        // 1. this.onerror=null; é˜²æ­¢æ— é™å¾ªç¯
        // 2. this.outerHTML=...; å¦‚æœå›¾ç‰‡æŒ‚äº†ï¼Œç›´æ¥æŠŠè‡ªå·±å˜æˆä¸€ä¸ªç°è‰²çš„ç›’å­ divï¼Œä¸å†å°è¯•åŠ è½½å›¾ç‰‡
        imgHtml = `<img src="${finalPath}" class="item-thumb"
                   onerror="this.onerror=null; this.outerHTML='<div class=\\'no-img\\'>ğŸ“¦</div>'">`;
      }

      // 2. çŠ¶æ€æ ‡å‡†åŒ–
      const rawStatus = item.status || 'pending';
      const normalizedStatus = rawStatus.toLowerCase();
      const statusClass = `status-${normalizedStatus}`;
      const statusText = normalizedStatus.charAt(0).toUpperCase() + normalizedStatus.slice(1);

      // 3. æ“ä½œæŒ‰é’®é€»è¾‘
      let actionsHtml = '';
      if (normalizedStatus === 'pending') {
        actionsHtml = `
            <button class="btn-action btn-approve" title="Approve" onclick="handleApprove(event, ${item.id})">âœ“</button>
            <button class="btn-action btn-reject" title="Reject" onclick="openRejectModal(event, ${item.id})">âœ•</button>
        `;
      } else {
        actionsHtml = `<span style="color:#ccc; font-size:0.9rem;">${statusText}</span>`;
      }

      // ğŸ”¥ 4. æ„å»ºå®¡æ ¸æ—¥å¿—åŒºåŸŸ (Audit Log)
      // å¦‚æœæœ‰å®¡æ ¸å¤‡æ³¨ï¼ˆæ‹’ç»ç†ç”±æˆ–é€šè¿‡å¤‡æ³¨ï¼‰ï¼Œåˆ™æ˜¾ç¤ºå‡ºæ¥
      let auditLogHtml = '';
      if (item.comment && normalizedStatus !== 'pending') {
        // æ ¹æ®çŠ¶æ€å†³å®šé¢œè‰²ï¼šæ‹’ç»æ˜¯çº¢è‰²èƒŒæ™¯ï¼Œé€šè¿‡æ˜¯ç»¿è‰²èƒŒæ™¯
        const logColor = normalizedStatus === 'rejected' ? '#FEF2F2' : '#F0FDF4'; // çº¢æ·¡è‰² vs ç»¿æ·¡è‰²
        const logBorder = normalizedStatus === 'rejected' ? '#FECACA' : '#BBF7D0';
        const logTitleColor = normalizedStatus === 'rejected' ? '#DC2626' : '#16A34A';

        auditLogHtml = `
            <div style="margin-top: 20px; background: ${logColor}; border: 1px solid ${logBorder}; padding: 15px; border-radius: 12px;">
                <h5 style="color: ${logTitleColor}; font-weight: 700; margin-bottom: 5px;">
                    ğŸ“ Audit Log (${statusText})
                </h5>
                <p style="color: #374151; font-size: 0.95rem;">${item.comment}</p>
            </div>
          `;
      }

      // ğŸ”¥ 5. æ¸²æŸ“ HTML
      const html = `
          <div class="audit-item" id="item-${item.id}">
              <div class="item-summary" onclick="toggleDetails(${item.id})">
                  ${imgHtml}
                  <div class="col-info">
                      <div style="display:flex; gap:5px; margin-bottom:5px;">
                          <span class="badge-cat">${item.category}</span>
                          <span class="badge-cat" style="background:#F3F4F6; color:#6B7280;">${item.condition || 'Used'}</span>
                      </div>
                      <h4>${item.title}</h4>
                      <p>ğŸ“… ${item.date}</p>
                  </div>
                  <div class="col-seller">
                      <div class="avatar" style="display:flex;align-items:center;justify-content:center;font-size:12px;">ğŸ‘¤</div>
                      <div>
                          <span class="seller-name">${item.seller}</span>
                          <div style="font-size:0.8rem; color:#9CA3AF;">ğŸ“ ${item.location || 'Unknown'}</div>
                      </div>
                  </div>
                  <div class="col-price">$${item.price.toFixed(2)}</div>
                  <div class="col-status">
                      <span class="${statusClass}">${statusText}</span>
                  </div>
                  <div class="col-actions">
                      ${actionsHtml}
                  </div>
              </div>

              <div class="item-details" id="details-${item.id}">
                  <div class="details-content">
                      <div class="detail-desc">
                          ${auditLogHtml} <br>
                          <span class="detail-label">Description</span>
                          <p class="detail-text">${item.description}</p>

                          <span class="detail-label">Images</span>
                          <div style="display:flex; gap:10px;">
                              ${imgHtml}
                              </div>
                      </div>
                      <div class="detail-meta">
                          <span class="detail-label">Item ID</span>
                          <p class="detail-text">#${item.id}</p>

                          <span class="detail-label">Condition</span>
                          <p class="detail-text">${item.condition || '-'}</p>

                          <span class="detail-label">Location</span>
                          <p class="detail-text">${item.location || '-'}</p>
                      </div>
                  </div>
              </div>
          </div>
      `;
      container.insertAdjacentHTML('beforeend', html);
    });
  }
  // --- 5. Toggle Details ---
  function toggleDetails(id) {
    const el = document.getElementById(`details-${id}`);
    if (el.classList.contains('open')) {
      el.classList.remove('open');
    } else {
      document.querySelectorAll('.item-details').forEach(d => d.classList.remove('open'));
      el.classList.add('open');
    }
  }

  // --- 6. Approve Logic ---
  async function handleApprove(e, id) {
    e.stopPropagation();
    if (confirm(`Are you sure you want to APPROVE Item #${id}?`)) {
      try {
        const res = await fetch(`${API_BASE}Audit_Product.php`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ product_id: id, action: 'approve' })
        });
        const result = await res.json();

        if (result.success) {
          // UI Removal Animation
          const itemEl = document.getElementById(`item-${id}`);
          itemEl.style.opacity = '0';
          setTimeout(() => itemEl.remove(), 300);
        } else {
          alert('Error: ' + result.msg);
        }
      } catch (err) {
        console.error(err);
        alert('Network Error');
      }
    }
  }

  // --- 7. Reject Logic ---
  function openRejectModal(e, id) {
    e.stopPropagation();
    currentRejectId = id;
    document.getElementById('rejectModal').classList.add('show');
    document.getElementById('rejectReasonInput').value = '';
    document.getElementById('rejectReasonInput').focus();
  }

  function closeRejectModal() {
    document.getElementById('rejectModal').classList.remove('show');
    currentRejectId = null;
  }

  async function confirmReject() {
    const reason = document.getElementById('rejectReasonInput').value.trim();
    if (!reason) {
      alert("Please enter a reason for rejection.");
      return;
    }

    try {
      const res = await fetch(`${API_BASE}Audit_Product.php`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ product_id: currentRejectId, action: 'reject', reason: reason })
      });
      const result = await res.json();

      if (result.success) {
        const itemEl = document.getElementById(`item-${currentRejectId}`);
        closeRejectModal();
        itemEl.style.opacity = '0';
        setTimeout(() => itemEl.remove(), 300);
      } else {
        alert('Error: ' + result.msg);
      }
    } catch (err) {
      console.error(err);
      alert('Network Error');
    }
  }
</script>

</body>
</html>
